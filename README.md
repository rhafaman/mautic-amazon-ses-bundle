# Plugin Amazon SES para Mautic 6

<p align="center">
<img src="Assets/img/icon.png" alt="Amazon SES" width="200"/>
</p>

<p align="center">
<strong>Plugin oficial para integra√ß√£o do Mautic 6 com Amazon Simple Email Service (SES)</strong>
</p>

---

## üöÄ **Recursos Aprimorados**

- ‚úÖ **Suporte a m√∫ltiplos esquemas:** `ses+api` e `ses+smtp`
- ‚úÖ **Processamento de callbacks SNS** para bounces e reclama√ß√µes
- ‚úÖ **Comando de debug avan√ßado** com diagn√≥stico completo
- ‚úÖ **Detec√ß√£o autom√°tica de email remetente** - sem necessidade de configura√ß√£o manual
- ‚úÖ **Valida√ß√£o flex√≠vel de secret keys** (suporta chaves de 20-128 caracteres)
- ‚úÖ **Testes reais de conex√£o AWS** com informa√ß√µes de quota
- ‚úÖ **Debug autom√°tico de exce√ß√µes de assinatura**
- ‚úÖ **Testes de conectividade SMTP/SSL**

---

## üì¶ **Instala√ß√£o**

### 1. Copiar o Plugin
```bash
cp -r examples/custom-plugins/plugins/AmazonSESBundle /caminho/para/mautic/plugins/
```

### 2. Limpar Cache
```bash
php bin/console cache:clear
```

### 3. Instalar Plugin
```bash
php bin/console mautic:plugins:reload
```

### 4. Verificar Instala√ß√£o
```bash
php bin/console mautic:amazon-ses:debug
```

---

## ‚öôÔ∏è **Configura√ß√£o**

### üîß **Op√ß√£o 1: SES API (Recomendado)**

**Melhor performance e compatibilidade**

**Formato DSN:** `ses+api://ACCESS_KEY:SECRET_KEY@default?region=REGIAO`

1. **Navegue para:** Configura√ß√£o ‚Üí Configura√ß√µes de Envio de Email
2. **Configure os campos:**

| Campo    | Valor                    |
| -------- | ------------------------ |
| Esquema  | `ses+api`               |
| Host     | `default`               |
| Porta    | `465`                   |
| Usu√°rio  | `<aws-access-key>`      |
| Senha    | `<aws-secret-key>`      |
| Regi√£o   | `<aws-region>`          |

### üîß **Op√ß√£o 2: SES SMTP**

**Compat√≠vel com configura√ß√µes SMTP tradicionais**

**Formato DSN:** `ses+smtp://ACCESS_KEY:SECRET_KEY@email-smtp.REGIAO.amazonaws.com:587?region=REGIAO`

1. **Navegue para:** Configura√ß√£o ‚Üí Configura√ß√µes de Envio de Email
2. **Configure os campos:**

| Campo    | Valor                                     |
| -------- | ----------------------------------------- |
| Esquema  | `ses+smtp`                               |
| Host     | `email-smtp.<regiao>.amazonaws.com`     |
| Porta    | `587` (STARTTLS) ou `465` (SSL)         |
| Usu√°rio  | `<aws-access-key>`                      |
| Senha    | `<aws-secret-key>`                      |
| Regi√£o   | `<aws-region>`                          |

### üìù **Notas sobre Credenciais**

- **Access Key:** Chave de acesso do usu√°rio IAM AWS (tipicamente 20 caracteres)
- **Secret Key:** Chave secreta do usu√°rio IAM AWS (pode ter 20-128 caracteres - todas suportadas)
- **Regi√£o:** Regi√£o AWS onde o SES est√° habilitado (`us-east-1`, `sa-east-1`, `eu-west-1`, etc.)
- **Caracteres Especiais:** Se sua secret key cont√©m `+`, `/`, `=`, etc., use URL encoding

---

## üîç **Debug e Testes Avan√ßados**

### üõ†Ô∏è **Comando de Debug Inteligente**

O plugin inclui um poderoso comando de debug com **detec√ß√£o autom√°tica de configura√ß√µes**:

```bash
# An√°lise completa da configura√ß√£o (recomendado para come√ßar)
php bin/console mautic:amazon-ses:debug

# Teste de conex√£o real com AWS SES
php bin/console mautic:amazon-ses:debug --test-connection

# Teste de conectividade SMTP (diagn√≥stico de rede)
php bin/console mautic:amazon-ses:debug --test-smtp-connectivity

# Envio de email de teste (com detec√ß√£o autom√°tica do remetente)
php bin/console mautic:amazon-ses:debug --test-email=seu-email@dominio.com

# Teste completo com email espec√≠fico do remetente
php bin/console mautic:amazon-ses:debug --test-email=destino@dominio.com --from=remetente@dominio-verificado.com

# Teste de reconhecimento de esquemas
php bin/console mautic:amazon-ses:debug --test-schemes
```

### üéØ **Detec√ß√£o Autom√°tica de Email Remetente**

**‚ú® NOVA FUNCIONALIDADE:** O plugin agora detecta automaticamente o email remetente!

**Ordem de prioridade de detec√ß√£o:**
1. **`mailer_from_email`** - Configura√ß√£o padr√£o do Mautic
2. **`webmaster_email`** - Email do administrador do sistema
3. **Email do DSN** - Se o usu√°rio do DSN for um email v√°lido
4. **Fallback autom√°tico** - Gera√ß√£o baseada no host atual

**Exemplo de sa√≠da:**
```bash
üìß Email Remetente Padr√£o:
‚úÖ Email detectado: admin@meusite.com.br
üìç Fonte: Configura√ß√£o mailer_from_email do Mautic
üí° Use este email com: --from=admin@meusite.com.br
```

### üìä **Recursos do Debug**

O comando de debug oferece an√°lise completa:

- ‚úÖ **Valida√ß√£o de DSN:** Verifica configura√ß√µes `ses+api` e `ses+smtp`
- ‚úÖ **Teste de Conex√£o AWS:** Conex√£o real ao SES com informa√ß√µes de quota
- ‚úÖ **Valida√ß√£o de Credenciais:** Suporte a chaves de diversos tamanhos
- ‚úÖ **Conectividade de Rede:** Testa conex√£o com endpoints AWS
- ‚úÖ **Teste de Email:** Envia emails reais atrav√©s da configura√ß√£o
- ‚úÖ **Diagn√≥stico de Erros:** Troubleshooting espec√≠fico para problemas comuns
- ‚úÖ **Detec√ß√£o de Email:** Identifica automaticamente email remetente
- ‚úÖ **An√°lise de Esquemas:** Verifica suporte a transportes

---

## üì° **Configura√ß√£o AWS SNS**

Para processar bounces e reclama√ß√µes automaticamente:

### 1. **Criar T√≥pico SNS**
- Vincule √† sua identidade SES
- Configure notifica√ß√µes de bounce e complaint

### 2. **Configurar Subscri√ß√£o**
- **Protocolo:** `HTTPS`
- **‚ö†Ô∏è IMPORTANTE:** Habilite "raw message delivery"
- **Endpoint:** `https://seu-dominio-mautic.com/mailer/callback`

### 3. **Confirma√ß√£o Autom√°tica**
O plugin confirma automaticamente as subscri√ß√µes SNS

---

## üö® **Troubleshooting**

### **1. Problemas de Timeout de Conex√£o (SSL/TLS)**

**Erro t√≠pico:**
```
Connection could not be established with host "ssl://email-smtp.us-east-1.amazonaws.com:465"
```

**Solu√ß√µes:**

**üîπ Problema de Porta 465:**
```bash
# Teste conectividade SMTP
php bin/console mautic:amazon-ses:debug --test-smtp-connectivity

# Mude para porta 587 (recomendado)
ses+smtp://ACCESS_KEY:SECRET_KEY@email-smtp.us-east-1.amazonaws.com:587?region=us-east-1
```

**üîπ Bloqueio de Firewall:**
- Contate seu provedor de hospedagem
- Verifique se as portas 587 e/ou 465 est√£o abertas

**üîπ Hospedagem Compartilhada:**
- Use esquema `ses+api` em vez de `ses+smtp`
- Alguns provedores oferecem porta alternativa 2587

### **2. InvalidSignatureException**

**Diagn√≥stico autom√°tico:**
```bash
php bin/console mautic:amazon-ses:debug --test-connection
```

**Solu√ß√µes:**
- URL-encode sua secret key se cont√©m caracteres especiais
- Verifique se as credenciais AWS est√£o corretas

**Exemplo de encoding:**
```bash
# Original (pode causar problemas)
wJalrXUt/K7MDENG+bPxRfi

# URL-encoded (recomendado)
wJalrXUt%2FK7MDENG%2BbPxRfi
```

### **3. MessageRejected Error**

**Causas comuns:**
- Endere√ßo remetente n√£o verificado no SES
- Conta em modo sandbox (s√≥ envia para emails verificados)
- Quota di√°ria excedida

**Solu√ß√£o:**
```bash
# Verificar quota e emails verificados
php bin/console mautic:amazon-ses:debug --test-connection
```

### **4. Problemas de Email Remetente**

**Com detec√ß√£o autom√°tica:**
```bash
# O plugin detecta automaticamente
php bin/console mautic:amazon-ses:debug --test-email=destino@domain.com

# Se n√£o detectar, especifique manualmente
php bin/console mautic:amazon-ses:debug --test-email=destino@domain.com --from=remetente@domain.com
```

---

## üîß **Configura√ß√µes Recomendadas**

### **Para ses+smtp (M√°xima Compatibilidade):**
```
Esquema: ses+smtp
Host: email-smtp.us-east-1.amazonaws.com
Porta: 587 (STARTTLS - recomendado)
Criptografia: STARTTLS
Autentica√ß√£o: Login
```

### **Para ses+api (Melhor Performance):**
```
Esquema: ses+api
Host: default
Porta: 465
Usu√°rio: <aws-access-key>
Senha: <aws-secret-key>
Regi√£o: <aws-region>
```

### **Prioridade de Portas:**
1. **ü•á Porta 587 (STARTTLS)** - Melhor compatibilidade
2. **ü•à Porta 465 (SSL)** - Pode causar timeouts
3. **ü•â Porta 2587** - Alternativa de alguns provedores

---

## üìã **Requisitos**

- **Mautic:** 6.0+
- **PHP:** 8.1+
- **Conta AWS SES** com dom√≠nio/email verificado
- **Symfony Amazon SES Bridge** (para esquema `ses+api`)
- **Extens√µes PHP:** curl, openssl, json

---

## üß™ **Desenvolvimento**

### **Arquitetura do Plugin:**
- Event subscribers para processamento de webhooks
- Comandos de console para debugging
- Classes de servi√ßo para manipula√ß√£o de bounces/complaints
- Logging abrangente para troubleshooting
- Factory de transporte personalizado para SES

### **Testes:**
```bash
# Teste completo do ambiente
php bin/console mautic:amazon-ses:debug --test-connection --test-smtp-connectivity

# Teste de email com an√°lise detalhada
php bin/console mautic:amazon-ses:debug --test-email=teste@domain.com --from=remetente@domain.com
```

---

## üìà **Monitoramento e Logs**

O plugin registra eventos importantes:
- Emails enviados com sucesso
- Erros de conex√£o e credenciais
- Processamento de bounces/complaints
- An√°lises de debug detalhadas

**Localiza√ß√£o dos logs:** `var/logs/` (pasta padr√£o do Mautic)

---

## üÜò **Suporte**

### **Problemas Comuns:**
1. **Timeout de conex√£o** ‚Üí Use `--test-smtp-connectivity`
2. **Email n√£o detectado** ‚Üí Configure `mailer_from_email` no Mautic
3. **Secret key inv√°lida** ‚Üí Use URL encoding para caracteres especiais
4. **Quota excedida** ‚Üí Verifique limites com `--test-connection`

### **Debug R√°pido:**
```bash
# Diagn√≥stico completo em um comando
php bin/console mautic:amazon-ses:debug --test-connection --test-smtp-connectivity --test-email=seu-email@domain.com
```

---

## üë• **Cr√©ditos**

**üîß Desenvolvimento Aprimorado:** Equipe de Desenvolvimento
**üìù Conceito Original:** Pablo Veintimilla

**Melhorias para Mautic 6:**
- Suporte a m√∫ltiplos esquemas de transporte
- Detec√ß√£o autom√°tica de configura√ß√µes
- Debug avan√ßado com testes reais
- Compatibilidade aprimorada com provedores de hospedagem

---

<p align="center">
<strong>üöÄ Plugin Amazon SES - Solu√ß√£o completa para envio de emails no Mautic 6</strong>
</p> 